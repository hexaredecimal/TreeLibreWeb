import{r as p,j as s,c as y,u as A,o as N,n as _,l as R,E as U,i as X}from"./vendor-e59bfd4a.js";import{n as P,F as S,i as c,u as v,o as G,I as $,d as q,W as J,p as O,q as L,_ as z,r as B,t as Q,v as Y,U as Z,w as W,x as ss,C as es,e as ts,j as as,g as k,B as M,P as ns,m as is,T as ls,k as os,y as rs,R as cs,z as ds}from"./index-51b49a5b.js";import{A as E}from"./AvatarWithTitle-10cf263d.js";const w=({color:t,label:e,children:u,now:n,min:o=0,max:a=100,className:m,onClick:i})=>{const[l,g]=p.useState(0),j=(h,C,T)=>{const I=(h-C)/(T-C)*100;return Math.round(I*1e3)/1e3};return p.useEffect(()=>{g(j(n,o,a))},[n,o,a]),s.jsxs("div",{className:y(P.root,m),children:[s.jsx("div",{className:y(P.progress,P[t]),style:{width:`${l}%`}}),s.jsx("div",{className:P.content,children:u||n})]})},us=({session:t})=>{var u,n,o,a,m,i,r,l;const{t:e}=A();return s.jsxs(S,{dataTest:"MetricsCell",flexWrap:"nowrap",spacing:5,alignItems:"center",className:c.MetricsCellChild,children:[s.jsxs(S,{bColumn:!0,spacing:1,flex:1,justifyContent:"center",children:[s.jsx("h4",{children:e("sessions.default")}),s.jsxs(w,{color:"primary",max:(u=t.metrics)==null?void 0:u.memoryAllocated,now:(n=t.metrics)==null?void 0:n.memoryUsed,children:[s.jsx("span",{children:"MEM: "+(((o=t.metrics)==null?void 0:o.memoryUsed)||0)+"MB"}),s.jsxs("small",{children:["(",t.metrics["memoryUsed.MIN"]||0,"|",t.metrics["memoryUsed.AVG"]||0,"|",t.metrics["memoryUsed.MAX"]||0,")"]})]}),s.jsxs(w,{color:"success",now:(a=t.metrics)==null?void 0:a.cpuUtilization,children:["CPU: "+(((m=t.metrics)==null?void 0:m.cpuUtilization)||0)+"% ",s.jsxs("small",{children:["(",t.metrics["cpuUtilization.MIN"]||0,"|",t.metrics["cpuUtilization.AVG"]||0,"|",t.metrics["cpuUtilization.MAX"]||0,")"]})]})]}),s.jsxs(S,{bColumn:!0,spacing:1,flex:1,justifyContent:"center",children:[s.jsx("h4",{children:e("sessions.bandwidth")}),s.jsxs(w,{color:"success",max:102400,now:(i=t.metrics)==null?void 0:i.inboundSize,children:["IN: "+Math.round(t.metrics.inboundSize/1024||0)+"k/s",s.jsxs("small",{children:["(",Math.round(t.metrics["inboundSize.MIN"]/1024),"|",Math.round(t.metrics["inboundSize.AVG"]/1024),"|",Math.round(t.metrics["inboundSize.MAX"]/1024),")"]})]}),s.jsxs(w,{color:"primary",max:102400,now:(r=t.metrics)==null?void 0:r.outboundSize,children:["OUT: "+Math.round(t.metrics.outboundSize/1024)+"k/s",s.jsxs("small",{children:["(",Math.round(t.metrics["outboundSize.MIN"]/1024),"|",Math.round(t.metrics["outboundSize.AVG"]/1024),"|",Math.round(t.metrics["outboundSize.MAX"]/1024),")"]})]})]}),s.jsxs(S,{bColumn:!0,spacing:1,flex:1,justifyContent:"center",children:[s.jsx("h4",{children:e("sessions.latency")}),s.jsxs(w,{color:"danger",max:700,now:t.metrics.latency,children:["E2E: "+(t.metrics.latency||0)+"ms",s.jsxs("small",{children:["(",t.metrics["latency.MIN"]||0,"|",t.metrics["latency.AVG"]||0,"|",t.metrics["latency.MAX"]||0,")"]})]}),s.jsxs(w,{color:"danger",max:500,now:(l=t.metrics)==null?void 0:l.latencyPing,children:["PING: "+(t.metrics.latencyPing||0)+"ms",s.jsxs("small",{children:["(",t.metrics["latencyPing.MIN"]||0,"|",t.metrics["latencyPing.AVG"]||0,"|",t.metrics["latencyPing.MAX"]||0,")"]})]})]})]})},ms=N(({session:t,bFinished:e=!1})=>{const{sessionsStore:u}=v(),n=_(),{pathname:o}=R(),{t:a}=A(),[m,i]=p.useState(!1),r=l=>{u.getWarningsNum(l)&&!e&&(n("/sessions"+l.applicationPath+"/"+l.id,{state:{previous:o}}),u.setActiveTab("warnings")),u.getWarningsNum(l)&&e&&i(g=>!g)};return s.jsxs(s.Fragment,{children:[s.jsxs("div",{"data-test":"warningCell",className:y(c.Cell,c.warningsCell,{[c.has]:u.getWarningsNum(t)}),onClick:()=>r(t),children:[u.isActionLoading(t.id,"threadDump")||u.isActionLoading(t.id,"heapDump")?s.jsx(G,{size:16,color:"neutral"}):s.jsx($,{name:"warning"}),u.getWarningsNum(t)?a("sessions.warningWithCount",{count:u.getWarningsNum(t)}):a("sessions.noWarnings")]}),s.jsx(q,{bOpen:m,title:a("sessions.warning_plural"),onToggle:l=>i(l),footer:!1,children:s.jsx(J,{session:t})})]})}),hs=N(({cols:t,isMetricColVisible:e})=>{const u=_(),{pathname:n,state:o}=R(),{sessionsStore:a,globalStore:m}=v(),i=a.sessionsTab,{tableRef:r,handleRowsRendered:l,goToPage:g,currentPage:j}=O({pageSize:a.pageSize,overlapSize:a.overlapSize,getTotalPages:()=>{var d,b;return((b=(d=a.sessions)==null?void 0:d.meta)==null?void 0:b.totalPages)||0},onVisibleIndexChange:d=>a.setCurrentVisibleIndex(d),loadData:async(d,b)=>{await a.loadSessionsOnDemand("forward",d,b)},dependencies:[i]});p.useEffect(()=>{if(a.shouldScrollToIndex&&a.currentVisibleIndex>=0){const d=a.currentVisibleIndex,b=Array.isArray(a.sessionsList)&&a.sessionsList.length>0;r.current&&typeof r.current.onScrollTo=="function"&&d>=0&&b&&setTimeout(()=>{if(r.current)try{r.current.onScrollTo(d),a.setShouldScrollToIndex(!1)}catch(D){console.warn("Error scrolling to position:",D),a.setShouldScrollToIndex(!1)}},100)}},[a.shouldScrollToIndex,a.sessionsList,a.currentVisibleIndex]),p.useEffect(()=>{const d=a.currentSessionPage;d>0&&d!==j&&g(d)},[a.currentSessionPage,g,j]);const h=p.useCallback(d=>{a.setCurrentVisibleIndex(d.index),u("/sessions"+d.rowData.applicationPath+"/"+d.rowData.id,{state:{previous:n}}),a.setActiveTab("view")},[history,i]);L();const C=p.useCallback(z(()=>{m.isAutoRefreshActive&&m.stopAutoReload(),a.loadSessionsOnDemand()},600),[]);let T=20;t.forEach(d=>{d.isVisible&&(T+=d.minWidth||0)});const{orderBy:I,orderDir:x}=a.orderMap[i]||{};return s.jsx("div",{style:{overflowX:"auto"},children:s.jsx(B,{ref:r,collection:a.sessionsList,totalCount:a.sessionsCount,minTableWidth:T,rowHeight:e?100:60,rowClassName:c.ac,threshold:500,onRowsRendered:l,columns:i==="sessions"?t==null?void 0:t.filter(d=>a.visibleColumns.includes(d.dataKey)):t,onRowDoubleClick:h,onRowRightClick:h,className:y(c.tableHeight,c.vTable),sortDirection:x,sortBy:I,onSort:({key:d,direction:b})=>{a.setOrder(i,d.toString(),b),C()}})})}),gs=(t,e)=>{const[u,n]=p.useState([]),{sessionsStore:o}=v(),a=[{dataKey:"applicationPath",label:"",align:"start",minWidth:35,width:35,className:c.actionCell,component:(r,l,g)=>s.jsx(Q,{session:l,index:g})},{dataKey:"application",label:e("sessions.app"),minWidth:200,align:"start",bSort:!0,className:y(c.defaultCell,c.gridAppCell),component:(r,l,g)=>s.jsx(Y,{session:l,index:g})},{dataKey:"users",label:e("logs.user"),minWidth:100,align:"start",bSort:!0,component:(r,l)=>s.jsx(Z,{session:l})},{dataKey:"userIp",label:e("logs.ip"),minWidth:100,align:"start",className:c.defaultCell},{dataKey:"startedAt",label:e("sessions.startTime"),minWidth:140,align:"start",bSort:!0,component:r=>s.jsx("div",{className:c.Cell,children:W(Number(r))})}],m={dataKey:"connected",label:e("general.status"),align:"start",minWidth:115,bSort:!0,component:(r,l)=>s.jsx(ss,{session:l})},i={dataKey:"warnings",label:e("sessions.warning_plural"),align:"start",minWidth:160,bSort:!0,component:(r,l)=>s.jsx(ms,{session:l,bFinished:t!=="sessions"})};return p.useEffect(()=>{const r=[...a];switch(t){case"sessions":{r.push(m),r.push(i),r.push({dataKey:"metrics",label:e("sessions.metrics"),align:"start",minWidth:500,className:c.actionCell,component:(l,g)=>s.jsx(us,{session:g})},{dataKey:"sessionPoolId",label:e("sessions.spId"),minWidth:278,align:"start",className:c.defaultCell},{dataKey:"pid",label:e("sessions.processId"),minWidth:100,align:"start",className:c.defaultCell},{dataKey:"id",label:e("sessions.instanceId"),minWidth:340,align:"start",className:c.defaultCell}),r.forEach(l=>{l.isVisible=!!o.visibleColumns.includes(l.dataKey)});break}case"closedSessions":{r.push({dataKey:"endedAt",label:e("sessions.endTime"),align:"start",minWidth:140,bSort:!0,isVisible:!0,component:l=>s.jsx("div",{className:c.Cell,children:W(Number(l))})}),r.push(m),r.push(i);break}}switch(n(r),t){case"threadDumps":o.setOrder("threadDumps","timestamp","DESC");break;case"recordings":o.setOrder("recordings","startDate","DESC");break;case"sessions":case"closedSessions":case"idle":o.setOrder(t,"startedAt","ASC");break;default:o.setOrder(t,"","");break}},[t]),[u,n]},ps="_root_11cg0_1",bs="_AvatarCol_11cg0_5",xs="_smCol_11cg0_9",Cs="_label_11cg0_15",f={root:ps,AvatarCol:bs,smCol:xs,label:Cs},Ss=N(function({app:e,className:u,onClick:n}){var l,g,j,h;const{globalStore:o,sessionsStore:a}=v(),m=a.sessions,i=(l=o.paths)==null?void 0:l.find(C=>C.path===`/${e}`),{t:r}=A();return s.jsx(es,{className:y(f.root,u),onClick:n,children:s.jsxs(S,{style:{padding:"0 1rem"},children:[s.jsx(S,{bColumn:!0,className:f.AvatarCol,flex:2,children:i?s.jsx(s.Fragment,{children:s.jsx(E,{size:"medium",src:ts+"/"+e+"/rest/appicon",title:i==null?void 0:i.name})}):s.jsx(E,{size:"medium",icon:"apps",title:"All Sessions"})}),i!==void 0&&s.jsxs(s.Fragment,{children:[s.jsxs(S,{bColumn:!0,flex:1,className:f.smCol,justifyContent:"center",children:[s.jsxs("span",{className:f.label,children:[r("general.status"),":"]}),s.jsx(as,{status:i==null?void 0:i.status,loadMessage:""})]}),s.jsxs(S,{bColumn:!0,flex:1,className:f.smCol,justifyContent:"center",children:[s.jsxs("span",{className:f.label,children:[r("apps.path"),":"]}),s.jsx("a",{href:i==null?void 0:i.url,target:"_blank",rel:"noreferrer",children:i==null?void 0:i.path})]})]}),s.jsxs(S,{bColumn:!0,flex:1,className:f.smCol,justifyContent:"center",dataTest:"appHeader-running",children:[s.jsxs("span",{className:f.label,children:[r("status.running"),":"]}),(g=m.stats)==null?void 0:g.sessions]}),s.jsxs(S,{bColumn:!0,flex:1,className:f.smCol,justifyContent:"center",dataTest:"appHeader-finished",children:[s.jsxs("span",{className:f.label,children:[r("status.idle"),":"]}),(j=m.stats)==null?void 0:j.idle]}),s.jsxs(S,{bColumn:!0,flex:1,className:f.smCol,justifyContent:"center",children:[s.jsxs("span",{className:f.label,children:[r("status.finished"),":"]}),(h=m.stats)==null?void 0:h.closedSessions]})]})})}),fs=N(({onChangeTab:t,tab:e})=>{const{permissionsStore:u,sessionsStore:n}=v(),{app:o}=U(),{t:a}=A(),m=i=>{t(i)};return s.jsxs(S,{className:c.btnstab,children:[n.shouldShowIdle()&&s.jsx(k,{className:c.rightSpace,icon:"hourglass_empty",active:e==="idle",onClick:()=>m("idle"),children:a("status.idle")}),s.jsx(k,{className:c.rightSpace,icon:"check",active:e==="sessions",onClick:()=>m("sessions"),children:a("status.running")}),s.jsx(k,{className:c.rightSpace,icon:"history",active:e==="closedSessions",onClick:()=>m("closedSessions"),children:a("status.finished")}),o&&u.get("playbackRecording")&&s.jsx(k,{className:c.rightSpace,icon:"videocam",active:e==="recordings",onClick:()=>m("recordings"),children:a("sessions.tab.recordings")}),o&&u.get("getThreadDump")&&s.jsx(k,{className:c.rightSpace,icon:"view_list",active:e==="threadDumps",onClick:()=>m("threadDumps"),children:a("sessions.tab.threadDumps")})]})}),js=N(({columns:t,onColumnVisibilityChange:e})=>{const[u,n]=p.useState(!1);return s.jsxs("div",{title:"Choose column",className:c.colSelector,children:[s.jsx(M,{color:"neutral",icon:"view_week",onClick:()=>n(o=>!o)}),s.jsx(ns,{darkBP:!0,backdrop:!0,width:240,className:y(c.selPopover),open:u,side:"right",onBlur:()=>n(o=>!o),children:s.jsx(S,{bColumn:!0,spacing:2,justifyContent:"center",style:{margin:"1rem"},children:t.map((o,a)=>s.jsx(p.Fragment,{children:o.label&&s.jsx(is,{disabled:o.label==="Application",value:o.isVisible,onClick:()=>e(String(o.dataKey)),children:s.jsx("span",{style:{cursor:"pointer"},onClick:()=>{o.label!=="Application"&&e(String(o.dataKey))},children:o.label})})},a))})})]})}),Ts=N(({app:t})=>{const{sessionsStore:e,globalStore:u}=v(),{t:n}=A(),[o,a]=p.useState([]),{tableRef:m,handleRowsRendered:i,isLoadingMore:r}=O({pageSize:e.pageSize,overlapSize:e.overlapSize,getTotalPages:()=>{var h,C;return((C=(h=e.sessions)==null?void 0:h.meta)==null?void 0:C.totalPages)||0},onVisibleIndexChange:h=>e.setCurrentVisibleIndex(h),loadData:async(h,C)=>{await e.loadSessionsOnDemand("forward",h,C)},dependencies:[t]}),l=[{dataKey:"application",label:n("sessions.app"),align:"start",width:300,className:c.defaultCell},{dataKey:"id",label:n("sessions.instanceId"),minWidth:400,align:"start",className:c.defaultCell,component:h=>s.jsx(ls,{content:n("sessions.instance")+" "+n("sessions.id")+": "+h,children:s.jsx("span",{children:h})})},{dataKey:"sessionPoolId",label:n("sessions.spId"),minWidth:280,align:"start",className:c.defaultCell},{dataKey:"pid",label:n("sessions.processId"),minWidth:100,align:"start",className:c.defaultCell},{dataKey:"startedAt",label:n("sessions.startTime"),minWidth:135,align:"start",bSort:!0,component:h=>s.jsx("div",{className:c.Cell,children:W(Number(h))})}],g=p.useCallback(()=>{a([...l])},[l]);L(),p.useEffect(()=>{g()},[]);const j=p.useCallback(z(()=>{u.isAutoRefreshActive&&u.stopAutoReload(),e.loadSessionsOnDemand()},600),[]);return s.jsx("div",{style:{overflowX:"auto"},children:s.jsx(B,{ref:m,collection:e.sessions.idle,totalCount:e.sessionsCount,minTableWidth:1055,rowHeight:60,rowClassName:c.ac,threshold:500,onRowsRendered:i,columns:o,className:y(c.tableHeight,c.vTable),onSort:({key:h,direction:C})=>{e.setOrder("idle",h,C),j()}})})}),ws=N(()=>{const{globalStore:t,sessionsStore:e,permissionsStore:u}=v(),{app:n}=U(),{pathname:o,state:a}=R(),{t:m}=A(),[i,r]=gs(e.sessionsTab,m),[l,g]=p.useState(!1),j=x=>{const d=i.map(b=>b.dataKey===x?{...b,isVisible:!b.isVisible}:b);e.setVisibleColumns(d.filter(b=>b.isVisible).map(b=>b.dataKey)),r(d)},h=p.useCallback(x=>{e.setSessionsTab(x),x==="closedSessions"&&e.setExtendTableToggle(!1),e.setCurrentVisibleIndex(0)},[e.setSessionsTab]),C=p.useCallback(z((x,d)=>T(x,d),600),[]),T=(x,d)=>{g(!0);const b=Date.now(),D=750,V=e.overlapSize,K=e.currentSessionPage;Promise.all([e.reloadCurrentSessions(),e.loadRecordingsOnDemand(x,d,void 0,K,V),e.loadThreadDumpsOnDemand(x,d,void 0,K,V)]).then(()=>{const F=Date.now()-b,H=Math.max(0,D-F);setTimeout(()=>{g(!1),a!=null&&a.previous&&e.currentVisibleIndex>=0&&e.setShouldScrollToIndex(!0)},H)}).catch(()=>{g(!1)})},I=x=>{e.setSearchTerm(x.target.value),C(n,!0)};return p.useEffect(()=>{o==="/sessions"?e.setIsAllSessions(!0):e.setIsAllSessions(!1),!n&&(e.sessionsTab==="recordings"||e.sessionsTab==="threadDumps")&&e.setSessionsTab("sessions"),t.updateApp(n),e.setAppPath(n),e.setActiveTab("view"),T(n)},[n,e.sessionsTab,o]),p.useEffect(()=>()=>{t.stopAutoReload()},[]),os(X.t("routes.sessions")),s.jsxs("div",{className:c.root,children:[s.jsx(Ss,{app:n}),s.jsxs(S,{className:c.headerRow,justifyContent:"space-between",alignItems:"center",children:[s.jsx(fs,{tab:e.sessionsTab,onChangeTab:h}),s.jsxs(S,{spacing:3,children:[s.jsx(M,{dataTest:"refreshButton",color:"neutral",icon:"refresh",bLoading:l,onClick:()=>{T(n,!1)}}),!e.filterToggle&&s.jsx(M,{dataTest:"filterSessions",color:"neutral",icon:"search",onClick:()=>e.setFilterToggle()}),e.filterToggle&&s.jsx(rs,{inputClassName:c.inputHeight,value:e.searchTerm,onChange:I,onClose:()=>e.setFilterToggle()}),e.sessionsTab==="sessions"&&s.jsx(js,{columns:i,onColumnVisibilityChange:j})]})]}),(e.sessionsTab==="sessions"||e.sessionsTab==="closedSessions")&&s.jsx(hs,{cols:i,app:n,isMetricColVisible:i.some(x=>x.dataKey==="metrics"&&x.isVisible)}),e.sessionsTab==="idle"&&s.jsx(Ts,{app:n}),e.sessionsTab==="recordings"&&u.get("playbackRecording")&&s.jsx(cs,{app:n}),e.sessionsTab==="threadDumps"&&u.get("getThreadDump")&&s.jsx(ds,{app:n})]})});export{ws as default};
